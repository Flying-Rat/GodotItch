# Proposal: itch.io Purchase Verification for Godot Games

## Problem Statement

Users download games from itch.io, but we need to verify they have legitimately purchased the product without requiring the itch.io launcher (which only a subset of users utilize). This verification must work for:
- Direct downloads from itch.io
- Standalone executables 
- HTML games embedded on itch.io pages
- Games distributed independently but sold on itch.io

## Research Summary: Available Verification Methods

Based on itch.io API documentation analysis, there are several approaches with different trade-offs:

### 1. Download Key Verification (Recommended for Direct Downloads)

**How it works:**
- Every itch.io purchase generates a unique download key embedded in the download URL
- Example: `https://leafo.itch.io/x-moon/download/YWKse5jeAeuZ8w3a5qO2b2PId1sChw2B9b637w6z`
- The download key is: `YWKse5jeAeuZ8w3a5qO2b2PId1sChw2B9b637w6z`

**API Endpoint:**
```
GET /api/1/YOUR_API_KEY/game/GAME_ID/download_keys?download_key=KEY
```

**Pros:**
- Most secure and tamper-proof
- Works for direct downloads without launcher
- No user input required (key embedded in download)
- Cannot be easily spoofed

**Cons:**
- Requires server-side verification (API key must be secret)
- Download key not available for HTML games embedded on itch.io
- Doesn't work for users who claimed free copies (different endpoint needed)

### 2. Email + Server-Side Verification

**How it works:**
- User enters their itch.io email address
- Game contacts your backend server
- Server verifies purchase using itch.io API

**API Endpoints:**
```
GET /api/1/YOUR_API_KEY/game/GAME_ID/purchases?email=USER_EMAIL
GET /api/1/YOUR_API_KEY/game/GAME_ID/download_keys?email=USER_EMAIL
```

**Pros:**
- Works for all purchase types (including claimed keys)
- User-friendly (just email input)
- Server controls verification logic

**Cons:**
- Requires backend server infrastructure
- User can potentially guess/fake email addresses
- Additional email verification step recommended

### 3. itch.io App Integration (JWT Tokens)

**How it works:**
- Game includes `.itch.toml` manifest requesting API scopes
- itch.io app injects JWT token via environment variable
- Game uses JWT token for direct API access

**Manifest Example:**
```toml
[[actions]]
name = "play"
path = "game.exe"
scope = ["profile:me"]
```

**API Access:**
```
GET /api/1/jwt/me
Authorization: Bearer JWT_TOKEN_FROM_ENV
```

**Pros:**
- Most secure (JWT tokens are short-lived)
- Direct API access from game
- No server infrastructure needed
- User authentication guaranteed

**Cons:**
- Only works with itch.io app (limited user base)
- Requires users to launch via app
- Not suitable if avoiding launcher dependency

### 4. HTML Games: No Direct Verification Available

**Research findings:**
- HTML games embedded on itch.io pages run in iframe sandbox
- No documented API for purchase verification within embedded games
- itch.io handles purchase gates at the page level, not game level
- Games must trust that itch.io only shows them to paying users

**Workarounds:**
- Server-side verification with user email input
- Custom purchase tokens generated by your backend
- Integration with itch.io widget API for purchase flow

## Recommended Implementation Strategy

### For Desktop/Mobile Games (Primary Recommendation)

**Option A: Download Key Extraction (Best Security)**
1. Embed download key extraction in game installer/launcher
2. Extract key from download URL or file metadata
3. Verify key against your backend server
4. Cache verification result locally

```gdscript
# Pseudo-implementation
func verify_purchase():
    var download_key = extract_download_key_from_install()
    if download_key:
        var response = await verify_key_with_server(download_key)
        return response.success
    return false
```

**Option B: Email Verification (User-Friendly Fallback)**
1. Prompt user for itch.io email on first run
2. Verify email against itch.io API via your server
3. Cache verification result with email hash

```gdscript
# Pseudo-implementation  
func verify_purchase_by_email(email: String):
    var response = await server_verify_email(email)
    if response.verified:
        save_verification_token(response.token)
        return true
    return false
```

### For HTML Games

**Limited Options:**
1. **Trust itch.io gating**: Assume users seeing your game have paid (itch.io handles this)
2. **Server verification**: Require email input + server-side verification
3. **Hybrid approach**: Detect if running on itch.io domain, skip verification

```gdscript
# Pseudo-implementation for HTML
func _ready():
    if is_running_on_itchio():
        # Trust itch.io's purchase gating
        enable_full_game()
    else:
        # Require verification for standalone version
        show_verification_dialog()
```

## Implementation Architecture

### Backend Server Requirements

**Required endpoints:**
```
POST /verify-download-key
Body: {"download_key": "...", "game_id": "..."}
Response: {"verified": true, "user_info": {...}}

POST /verify-email  
Body: {"email": "...", "game_id": "..."}
Response: {"verified": true, "token": "..."}
```

**Security considerations:**
- Store itch.io API key securely (environment variables)
- Rate limit verification requests
- Cache verification results to reduce API calls
- Use HTTPS for all communications
- Consider token expiration for cached results

### Godot Implementation

**GDScript addon structure:**
```
addons/itch_verification/
  ├── plugin.cfg
  ├── verification.gd          # Main verification class
  ├── download_key_extractor.gd # Extract keys from installation
  └── server_client.gd         # Backend communication
```

**Key features:**
- Automatic download key detection
- Graceful fallback to email verification
- Offline mode for previously verified users
- Clear error messages and retry logic

## Trade-offs Summary

| Method | Security | User Experience | Server Required | itch.io App Dependency |
|--------|----------|-----------------|-----------------|----------------------|
| Download Key | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ❌ |
| Email Verification | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ❌ |
| JWT Tokens | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ❌ | ⭐⭐⭐ |
| HTML Trust | ⭐ | ⭐⭐⭐⭐⭐ | ❌ | ❌ |

## Next Steps

1. **Create proof-of-concept**: Implement download key extraction + server verification
2. **Build backend API**: Simple verification server with rate limiting
3. **Test with real itch.io purchases**: Validate key extraction works correctly
4. **Add email fallback**: For edge cases where key extraction fails
5. **Documentation**: Clear setup guide for developers

## References

- [itch.io Server-side API](https://itch.io/docs/api/serverside)
- [itch.io App Integration](https://itch.io/docs/itch/integrating/api/)
- [App Manifests](https://itch.io/docs/itch/integrating/manifest.html)
- [Web Games](https://itch.io/docs/itch/integrating/platforms/web.html)
